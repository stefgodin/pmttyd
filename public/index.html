<!DOCTYPE html>
<html lang="en">

<head>
    <title>PMTTYD - Badges</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <link id="badgedata" rel="preload" href="/assets/badges.json" as="fetch" crossorigin="anonymous">
    <link id="badgesprite" rel="preload" href="/assets/badges.png" as="image">
    <link id="itemdata" rel="preload" href="/assets/items.json" as="fetch" crossorigin="anonymous">
    <link id="itemsprite" rel="preload" href="/assets/items.png" as="image">

    <!-- xs -->
    <style>
        @media not print {
            img.decoded {
                background: none !important;
            }
        }

        @font-face {
            font-family: 'HeyGorgeous';
            src: url('/static/heygorgeous.ttf');
        }

        :root {
            --color-light: white;
            --color-base: grey;
            --color-dark: black;

            font-family: Verdana, sans-serif;
        }

        .badges {
            --color-light: #c5fd81;
            --color-base: #41de30;
            --color-dark: #259a19;
        }

        .recipes {
            --color-light: #e39bbf;
            --color-base: #da7aaa;
            --color-dark: #b43273;
        }

        .free-red {
            --color-light: #e7a698;
            --color-base: #da7762;
            --color-dark: #d05840;
        }

        .starpieces {
            --color-light: #ebd193;
            --color-base: #e6c576;
            --color-dark: #c29323;
        }

        .shinesprites {
            --color-light: #9abce5;
            --color-base: #558ed3;
            --color-dark: #2f6cb6;
        }

        .tattlelog {
            --color-light: #bfb2cd;
            --color-base: #876fa1;
            --color-dark: #59476c;
        }

        html {
            margin: 0;
            padding: 0;
            min-height: 100%;
        }

        body {
            background-image: url('/static/background_1.png');
            background-size: cover;
            background-repeat: no-repeat;
            min-height: 100%;
            margin: 0;
            padding: 0;
        }

        main {
            margin-top: 3em;
            padding: 0.25em;
            max-width: 996px;
            margin-left: auto;
            margin-right: auto;
        }

        .hidden {
            display: none;
        }

        .list-container {
            background-size: 200px;
            background-color: var(--color-base);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
        }

        .list {
            list-style-type: none;
            margin: 0;
            background-color: transparent;
            background-image: url('/static/items_background.png');
            background-size: 200px;
            padding: 1em;
            border-radius: 10px;
            background-color: var(--color-light);
        }

        .list li {
            display: inline-block;
            filter: drop-shadow(0px 0px 3px);
        }

        .list li:hover {
            transform: scale(1.1);
            filter: drop-shadow(0px 0px 3px) brightness(1.2);
        }

        nav {
            width: 100%;
            position: absolute;
            top: 0;
        }

        .nav-content {
            width: 100%;
            max-width: 996px;
            margin-left: auto;
            margin-right: auto;
        }

        nav .nav-section {
            position: relative;
            vertical-align: top;
            display: inline-block;
            padding-top: 0.5em;
            padding-bottom: 0.25em;
            padding-left: 0.25em;
            padding-right: 0.25em;
            background-color: var(--color-dark);
            background-image: linear-gradient(to right, var(--color-base), var(--color-dark));
            border-radius: 0 0 20px 20px;
            color: white;
            font-weight: bolder;
            font-size: 24px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23);
        }

        .nav-section:first-child {
            margin-left: 0.5em;
        }

        nav .nav-section.active {
            background-image: linear-gradient(to right, var(--color-light), var(--color-dark));
            padding-top: 1.25em;
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);
        }

        nav a {
            text-decoration: none;
        }

        dialog {
            scrollbar-width: none;
        }

        .item-dialog {
            border: none;
            background-color: transparent;
        }

        .item-dialog.badges {
            max-width: 600px;
        }

        .item-dialog::backdrop {
            background-color: black;
            opacity: 0.2;
        }

        .item-dialog-body {
            padding: 20px 0;
            background-size: 200px;
            background-color: var(--color-base);
            border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
        }

        .item-dialog-content {
            background-image: url('/static/items_background.png');
            background-size: 200px;
            padding: 1em;
            background-color: var(--color-light);
        }

        .item-sprite {
            display: inline-block;
        }

        .item-title {
            font-family: HeyGorgeous;
            font-size: 1.25em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .item-description {
            font-family: HeyGorgeous;
            white-space: pre-line;
        }

        .dialog-close-button {
            position: sticky;
            bottom: 0;
        }

        .badge-points {
            font-family: HeyGorgeous;
            margin-bottom: 1.5em;
        }

        .text-bubble {
            font-size: 0.75em;
            text-align: left;
            position: relative;
            background-color: white;
            border-radius: 20px;
            box-shadow: inset 0px -5px 5px 0px rgba(0, 0, 0, 0.5);
            padding: 2em 1em;
            margin-top: -10px;
            margin-left: 0.15em;
            margin-right: 0.15em;
            margin-bottom: 20px;
        }

        .text-bubble-close-button {
            cursor: pointer;
            position: absolute;
            bottom: -20px;
            right: -20px;
            background-image: url('/static/small_star.png');
            background-color: transparent;
            border: 0;
            height: 60px;
            width: 60px;
            padding: 0;
        }

        .tab-item {
            display: none;
        }

        .tab-item.active {
            display: unset;
        }

        .badge-tabs {
            position: relative;
            z-index: 10;
            margin-top: -3em;
        }

        .tabs {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }

        .tab-button {
            position: relative;
            font-family: HeyGorgeous;
            padding: 0.75em 1em;
            color: white;
            background-color: var(--color-dark);
            border-color: var(--color-base);
            border-style: outset;
        }

        .tab-button:hover::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0.05;
            background-color: black;
        }

        .tab-button.active,
        .tab-button:active {
            color: black;
            background-color: var(--color-base);
            border-color: var(--color-base);
            border-style: inset;
        }

        .tab-button:first-child {
            border-radius: 10px 0 0 10px;
        }

        .tab-button:last-child {
            border-radius: 0 10px 10px 0;
        }

        .recipe-list-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25em;
        }
    </style>

    <!-- sm -->
    <style media="(min-width: 576px)">
        main {
            padding: 1em;
        }

        .nav-section:first-child {
            margin-left: 1em;
        }

        .text-bubble {
            margin-left: 1em;
            margin-right: 1em;
        }
    </style>

    <!-- md -->
    <style media="(min-width: 768px)">
    </style>

    <!-- lg -->
    <style media="(min-width: 992px)">
    </style>

    <!-- xl -->
    <style media="(min-width: 1200px)">
    </style>
</head>

<body>
    <nav>
        <div class="nav-content">
            <a class="nav-section badges" href="#badges" title="Badges">
                <item-sprite src="/assets/menu.png" size="100" index="0" scale="0.4" scale-sm="0.5"></item-sprite>
            </a>
            <a class="nav-section recipes" href="#recipes" title="Recipes">
                <item-sprite src="/assets/menu.png" size="100" index="1" scale="0.4" scale-sm="0.5"></item-sprite>
            </a>
            <a class="nav-section starpieces" href="#starpieces" title="Star Pieces">
                <item-sprite src="/assets/menu.png" size="100" index="2" scale="0.4" scale-sm="0.5"></item-sprite>
            </a>
            <a class="nav-section shinesprites" href="#shinesprites" title="Shine Sprites">
                <item-sprite src="/assets/menu.png" size="100" index="3" scale="0.4" scale-sm="0.5"></item-sprite>
            </a>
            <a class="nav-section tattlelog" href="#tattlelog" title="Tattle Log">
                <item-sprite src="/assets/menu.png" size="100" index="4" scale="0.4" scale-sm="0.5"></item-sprite>
            </a>
        </div>
    </nav>
    <main>
        <div class="section list-container badges">
            <template id="badge-item-tpl">
                <li>
                    <a href="" title="">
                        <item-sprite src="/assets/badges.png" size="100" index="" scale="0.5"
                            scale-md="0.6"></item-sprite>
                    </a>
                </li>
            </template>
            <ul class="list"></ul>

            <dialog class="item-dialog badges">
                <div class="item-dialog-body">
                    <div class="item-dialog-content">
                        <item-sprite class="item-sprite" src="/assets/badges.png" size="100" index=""></item-sprite>
                        <div class="item-title"></div>
                        <div class="badge-points"></div>
                    </div>
                </div>
                <div class="tabs badge-tabs">
                    <button class="tab-button active effect-button" target="badge-effect" type="button" title="Effect">
                        Effect
                    </button>
                    <button class="tab-button locations-button" target="badge-locations" type="button"
                        title="Locations">
                        Locations
                    </button>
                </div>
                <div class="text-bubble">
                    <div class="tab-item active item-description badge-effect"></div>
                    <div class="tab-item item-description badge-locations"></div>
                    <button type="button" autofocus class="dialog-close-button text-bubble-close-button"></button>
                </div>
            </dialog>
        </div>
        <div class="section recipes">
            <template id="recipe-item-tpl">
                <li>
                    <a href="" title="">
                        <item-sprite src="/assets/items.png" size="100" index="" scale="0.5"
                            scale-md="0.6"></item-sprite>
                    </a>
                </li>
            </template>
            <div class="list-container recipe-list">
                <ul class="list"></ul>
            </div>
            <div class="list-container item-list">
                <ul class="list"></ul>
            </div>

            <dialog class="item-dialog recipes">
                <div class="item-dialog-body">
                    <div class="item-dialog-content">
                        <item-sprite class="item-sprite" src="/assets/items.png" size="100" index=""></item-sprite>
                        <div class="item-title"></div>

                        <div class="item-used-in-container recipe-list-container"></div>
                        <hr>
                        <div class="item-made-with-container recipe-list-container"></div>
                    </div>
                </div>
            </dialog>
        </div>
        <div class="section list-container starpieces">
            <ul class="list">
                <li>Comming Soon</li>
            </ul>
        </div>
        <div class="section list-container shinesprites">
            <ul class="list">
                <li>Comming Soon</li>
            </ul>
        </div>
        <div class="section list-container tattlelog">
            <ul class="list">
                <li>Comming Soon</li>
            </ul>
        </div>
    </main>

    <script>
        const $mediaQueries = {
            sm: window.matchMedia("(min-width: 576px)"),
            md: window.matchMedia("(min-width: 768px)"),
            lg: window.matchMedia("(min-width: 992px)"),
            xl: window.matchMedia("(min-width: 1200px)"),
        };

        const $dataLoader = {
            loadBadgesData: (() => {
                let badgesPromise = null;
                return async () => {
                    if (badgesPromise === null) {
                        const datasrc = document.getElementById('badgedata').href;
                        badgesPromise = fetch(datasrc).then((r) => r.json());
                    }
                    return badgesPromise;
                }
            })(),
            loadItemsData: (() => {
                let itemsPromise = null;
                return async () => {
                    if (itemsPromise === null) {
                        const datasrc = document.getElementById('itemdata').href;
                        itemsPromise = fetch(datasrc).then((r) => r.json()).then((items) => {
                            const itemAsIngredientMap = {};
                            for (let item of items) {
                                for (let recipe of item.recipes ?? []) {
                                    for (let recipeItem of recipe.items) {
                                        itemAsIngredientMap[recipeItem] ??= [];
                                        if (!itemAsIngredientMap[recipeItem].includes(item.id)) {
                                            itemAsIngredientMap[recipeItem].push(item.id);
                                        }
                                    }
                                }
                            }

                            for (let itemId in itemAsIngredientMap) {
                                items[itemId - 1].usedIn = itemAsIngredientMap[itemId];
                            }

                            return items;
                        });
                    }
                    return itemsPromise;
                }
            })()
        };
    </script>

    <script>
        (($mediaQueries) => {
            const spritesheetPromises = {};
            const getSpritesheetWidth = async (src) => {
                if (spritesheetPromises[src] !== undefined) {
                    return spritesheetPromises[src];
                }

                return spritesheetPromises[src] = new Promise((res, rej) => {
                    const img = new Image();
                    img.src = src;
                    img.onload = () => res(img.width);
                    img.onerror = (e) => {
                        delete spritesheetPromises[src];
                        rej(e);
                    };
                });
            }

            class ItemSprite extends HTMLElement {
                static get observedAttributes() {
                    return ['index', 'src', 'size', 'scale', 'scale-sm', 'scale-md', 'scale-lg', 'scale-xl'];
                }

                attributeChangedCallback() {
                    this.update();
                }

                connectedCallback() {
                    this.update();
                }

                async update() {
                    const index = this.index;
                    const size = this.size;
                    const src = this.src;
                    const scale = this.scale;

                    const spritesheetWidth = await getSpritesheetWidth(src);

                    const styleRules = [
                        (src !== '' ? `background-image: url(${src})` : ''),
                        `background-color: transparent`,
                        `background-position: -${index * size * scale}px 0px`,
                        `background-size: ${scale * spritesheetWidth}px`,
                        `width: ${size * scale}px`,
                        `height: ${size * scale}px`,
                    ];
                    this.innerHTML = `<div style="${styleRules.join(';')}">`;
                }

                get index() {
                    const index = parseInt(this.getAttribute('index') ?? 0);
                    if (isNaN(index) || index < 0) {
                        return 0;
                    }
                    return index;
                }

                get size() {
                    const size = parseInt(this.getAttribute('size') ?? 0);
                    if (isNaN(size) || size < 0) {
                        return 0;
                    }
                    return size;
                }

                get scale() {
                    let scale = this.getAttribute('scale') ?? 1.0;
                    for (let code in $mediaQueries) {
                        if ($mediaQueries[code].matches && this.hasAttribute(`scale-${code}`)) {
                            scale = this.getAttribute(`scale-${code}`);
                        }
                    }

                    scale = parseFloat(scale);
                    if (isNaN(scale)) {
                        return 1.0;
                    }
                    return scale;
                }

                get src() {
                    return this.getAttribute('src') ?? '';
                }
            }

            window.customElements.define('item-sprite', ItemSprite);
        })($mediaQueries);

        function createItemSprite(dom, {index, src, size, scale = null, scaleSm = null, scaleMd = null, scaleLg = null, scaleXl = null}) {
            const el = dom.createElement('item-sprite');
            el.setAttribute('index', index);
            el.setAttribute('src', src);
            el.setAttribute('size', size);
            el.setAttribute('scale', scale);
            el.setAttribute('scale-sm', scaleSm);
            el.setAttribute('scale-md', scaleMd);
            el.setAttribute('scale-lg', scaleLg);
            el.setAttribute('scale-Xl', scaleXl);
            return el;
        }
    </script>

    <template id="recipe-tpl">
        <style>
            .recipe {}

            .ingredients {
                display: flex;
            }

            .ingredient {
                padding: 0.125em;
            }

            .result {
                padding: 0.25em;
            }

            .hidden {
                display: none;
            }
        </style>
        <div class="recipe">
            <div class="ingredients">
                <div class="ingredient">
                    <a>
                        <item-sprite src="/assets/items.png" size="100" scale="0.3"></item-sprite>
                    </a>
                </div>
                <div class="ingredient hidden">
                    <a>
                        <item-sprite src="/assets/items.png" size="100" scale="0.3"></item-sprite>
                    </a>
                </div>
                <div class="ingredient hidden" style="width: 30px; height: 30px;"></div>
            </div>
            <div class="result">
                <a>
                    <item-sprite src="/assets/items.png" size="100" scale="0.6"></item-sprite>
                </a>
            </div>
        </div>
    </template>
    <script>
        (($dataLoader) => {
            const TPL_ID = 'recipe-tpl';
            class RecipeElement extends HTMLElement {
                static get observedAttributes() {
                    return ['item', 'first-ingredient', 'second-ingredient'];
                }

                attributeChangedCallback() {
                    this.update();
                }

                connectedCallback() {
                    this.update();
                }

                constructor() {
                    super();
                    let template = document.getElementById(TPL_ID);

                    this.shadowDOM = this.attachShadow({mode: "open"});
                    this.shadowDOM.appendChild(template.content.cloneNode(true));
                }

                get itemId() {
                    const id = parseInt(this.getAttribute('item'));
                    return isNaN(id) ? 0 : id;
                }

                get firstIngredientId() {
                    const id = parseInt(this.getAttribute('first-ingredient'));
                    return isNaN(id) ? 0 : id;
                }

                get secondIngredientId() {
                    const id = parseInt(this.getAttribute('second-ingredient'));
                    return isNaN(id) ? 0 : id;
                }

                async update() {
                    const updateItemElement = (el, item) => {
                        el.querySelector('item-sprite').setAttribute('index', (item?.id ?? 0) - 1);
                        const anchorEl = el.querySelector('a');
                        anchorEl.setAttribute('href', `#recipes/${item?.id ?? ''}`);
                        anchorEl.setAttribute('title', item?.name ?? '');
                    };

                    const items = await $dataLoader.loadItemsData();

                    const itemEl = this.shadowDOM.querySelector('.result');
                    updateItemElement(itemEl, items[this.itemId - 1] ?? null);

                    const ingredientElList = this.shadowDOM.querySelectorAll('.ingredient');
                    const firstIngredientEl = ingredientElList[0];
                    const secondIngredientEl = ingredientElList[1];
                    const nullIngredientEl = ingredientElList[2];

                    updateItemElement(firstIngredientEl, items[this.firstIngredientId - 1] ?? null);

                    if (this.secondIngredientId > 0) {
                        nullIngredientEl.classList.add('hidden');
                        secondIngredientEl.classList.remove('hidden');
                        updateItemElement(secondIngredientEl, items[this.secondIngredientId - 1] ?? null);
                    }
                    else {
                        secondIngredientEl.classList.add('hidden');
                        nullIngredientEl.classList.remove('hidden');
                    }
                }

            }

            window.customElements.define('app-recipe', RecipeElement);
        })($dataLoader);

        function createRecipeElement(dom, {item, firstIngredient, secondIngredient = null}) {
            const el = dom.createElement('app-recipe');
            el.setAttribute('item', item);
            el.setAttribute('first-ingredient', firstIngredient);
            el.setAttribute('second-ingredient', secondIngredient ?? '');
            return el;
        }
    </script>

    <script>
        (() => {
            const SECTIONS = {
                BADGES: "badges",
                RECIPES: "recipes",
                STARPIECES: "starpieces",
                SHINESPRITES: "shinesprites",
                TATTLELOG: "tattlelog",
            };

            function getSectionFromHash() {
                const sectionId = (window.location.hash ?? '').replace('#', '').split('/')[0];
                return Object.values(SECTIONS).includes(sectionId) ? sectionId : SECTIONS.BADGES;
            }

            function getItemIdFromHash() {
                const id = parseInt((window.location.hash ?? '').split('/')[1] ?? 0)
                return isNaN(id) ? 0 : id;
            }

            function updateContent() {
                const sectionId = getSectionFromHash();
                const itemId = getItemIdFromHash();
                updateNav(sectionId);
                updateLists(sectionId);
                updateDialogs(sectionId, itemId);
            };

            function updateNav(sectionId) {
                const sections = document.querySelectorAll('.nav-section');
                for (const sectionEl of sections) {
                    if (sectionEl.classList.contains(sectionId)) {
                        sectionEl.classList.add('active');
                    }
                    else {
                        sectionEl.classList.remove('active');
                    }
                }
            };

            function updateLists(sectionId) {
                const listContainers = document.querySelectorAll('.section');
                for (const listContainerEl of listContainers) {
                    if (listContainerEl.classList.contains(sectionId)) {
                        listContainerEl.classList.remove('hidden');
                    }
                    else {
                        listContainerEl.classList.add('hidden');
                    }
                }
            };

            let badgesPromise = null;
            async function loadBadgesData() {
                if (badgesPromise === null) {
                    const datasrc = document.getElementById('badgedata').href;
                    badgesPromise = fetch(datasrc).then((r) => r.json());
                }
                return badgesPromise;
            }

            async function loadBadgeSection() {
                const data = await loadBadgesData();

                const list = document.querySelector('.list-container.badges .list');
                while (list.firstChild) {
                    list.firstChild.remove();
                }

                const badgeItemTpl = document.getElementById('badge-item-tpl');
                let i = 0;
                for (const badge of data) {
                    const el = badgeItemTpl.content.cloneNode(true);
                    el.querySelector('item-sprite').setAttribute('index', i);
                    const link = el.querySelector('a');
                    link.setAttribute('href', `#badges/${badge.id}`);
                    link.setAttribute('title', badge.name);
                    list.appendChild(el);
                    i++;
                }
            }

            let itemsPromise = null;
            async function loadItemsData() {
                if (itemsPromise === null) {
                    const datasrc = document.getElementById('itemdata').href;
                    itemsPromise = fetch(datasrc).then((r) => r.json()).then((items) => {
                        const itemAsIngredientMap = {};
                        for (let item of items) {
                            for (let recipe of item.recipes ?? []) {
                                for (let recipeItem of recipe.items) {
                                    itemAsIngredientMap[recipeItem] ??= [];
                                    if (!itemAsIngredientMap[recipeItem].includes(item.id)) {
                                        itemAsIngredientMap[recipeItem].push(item.id);
                                    }
                                }
                            }
                        }

                        for (let itemId in itemAsIngredientMap) {
                            items[itemId - 1].usedIn = itemAsIngredientMap[itemId];
                        }

                        return items;
                    });
                }
                return itemsPromise;
            }

            async function loadRecipeSection() {
                const data = await loadItemsData();

                const recipeList = document.querySelector('.list-container.recipe-list .list');
                while (recipeList.firstChild) {
                    recipeList.firstChild.remove();
                }

                const itemList = document.querySelector('.list-container.item-list .list');
                while (itemList.firstChild) {
                    itemList.firstChild.remove();
                }

                const itemTpl = document.getElementById('recipe-item-tpl');
                let i = 0;
                for (const item of data) {
                    const el = itemTpl.content.cloneNode(true);
                    el.querySelector('item-sprite').setAttribute('index', i);
                    const link = el.querySelector('a');
                    link.setAttribute('href', `#recipes/${item.id ?? 0}`);
                    link.setAttribute('title', item.name);

                    if (item?.recipeEntry) {
                        recipeList.appendChild(el);
                    }
                    else {
                        itemList.appendChild(el);
                    }
                    i++;
                }
            }

            function updateDialogs(sectionId, itemId) {
                if (itemId === 0) {
                    const dialogs = document.querySelectorAll('.item-dialog');
                    for (const dialog of dialogs) {
                        dialog.close();
                    }
                    return;
                }

                switch (sectionId) {
                    case SECTIONS.BADGES:
                        openBadgeDialog(itemId);
                        break;
                    case SECTIONS.RECIPES:
                        openRecipeDialog(itemId);
                        break;
                }
            }

            async function openBadgeDialog(itemId) {
                const badges = await loadBadgesData();
                const index = badges.findIndex(({id}) => id === itemId);
                const dialog = document.querySelector('.item-dialog.badges');
                if (index === -1) {
                    dialog.close();
                    return;
                }
                const badge = badges[index];

                dialog.querySelector('item-sprite').setAttribute('index', index);

                dialog.querySelector('.item-title').textContent = badge.name;

                dialog.querySelector('.badge-points').textContent = `${badge.bp} BP`;
                dialog.querySelector('.item-description.badge-effect').textContent = badge.effect.replaceAll(/\. ([A-Z])/g, '.\n\n$1').trim('\n');
                dialog.querySelector('.item-description.badge-locations').textContent = badge.locations.replaceAll('\n', '\n\n').trim('\n');

                dialog.showModal();
            }

            async function openRecipeDialog(itemId) {
                const items = await loadItemsData();
                const index = items.findIndex(({id}) => id === itemId);
                const dialog = document.querySelector('.item-dialog.recipes');
                if (index === -1) {
                    dialog.close();
                    return;
                }
                const item = items[index];

                dialog.querySelector('item-sprite').setAttribute('index', index);
                dialog.querySelector('.item-title').textContent = item.name;

                const usedInContainerEl = dialog.querySelector('.item-used-in-container');
                while (usedInContainerEl.firstChild) {
                    usedInContainerEl.firstChild.remove();
                }
                for (let usedInItemId of (item.usedIn ?? [])) {
                    const usedInItem = items[usedInItemId - 1] ?? null;
                    for (const recipe of (usedInItem?.recipes ?? [])) {
                        if (!recipe.items.includes(item.id)) {
                            continue;
                        }

                        const recipeEl = createRecipeElement(document, {
                            item: usedInItem.id,
                            firstIngredient: recipe.items[0],
                            secondIngredient: recipe.items[1] ?? null
                        });
                        usedInContainerEl.appendChild(recipeEl);
                    }
                }

                const madeWithContainerEl = dialog.querySelector('.item-made-with-container');
                while (madeWithContainerEl.firstChild) {
                    madeWithContainerEl.firstChild.remove();
                }
                for (let recipe of (item.recipes ?? [])) {
                    const recipeEl = createRecipeElement(document, {
                        item: item.id,
                        firstIngredient: recipe.items[0],
                        secondIngredient: recipe.items[1] ?? null
                    });
                    madeWithContainerEl.appendChild(recipeEl);
                }

                dialog.showModal();
            }

            // Initialization
            loadBadgeSection();
            loadRecipeSection();
            updateContent();

            window.addEventListener('hashchange', updateContent);

            for (const dialog of document.querySelectorAll('dialog.item-dialog')) {
                dialog.addEventListener('click', function (event) {
                    const {top, left, width, height} = dialog.getBoundingClientRect();
                    const [x, y] = [event.clientX, event.clientY];
                    if (top > y || y > (top + height) || left > x || x > (left + width)) {
                        dialog.close();
                    }
                });
                dialog.querySelector('.dialog-close-button')?.addEventListener('click', () => dialog.close());
                dialog.addEventListener('close', () => window.location.hash = `#${getSectionFromHash()}`);

                for (const btn of dialog.querySelectorAll('.tab-button')) {
                    btn.addEventListener('click', function (event) {
                        event.preventDefault();
                        for (const btn of dialog.querySelectorAll('.tab-button')) {
                            if (btn === event.target) {
                                btn.classList.add('active');
                            }
                            else {
                                btn.classList.remove('active');
                            }
                        }

                        const targetClass = event.target.getAttribute('target');
                        for (const el of dialog.querySelectorAll('.tab-item')) {
                            if (el.classList.contains(targetClass)) {
                                el.classList.add('active');
                            }
                            else {
                                el.classList.remove('active');
                            }
                        }
                    });
                }
            }
        })();
    </script>
</body>

</html>
